---
- name: Rolling system update for all nodes
  hosts: all
  become: true
  serial: 1
  vars:
    exclude_pkgs: "kubelet,kubeadm,kubectl"

  tasks:
    - name: Check if node is part of Kubernetes cluster
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: k8s_conf

    - name: Set Kubernetes Node Name
      set_fact:
        k8s_node_name: "{{ inventory_hostname | lower }}"

    - name: Drain node
      command: >
        kubectl drain {{ k8s_node_name }}
        --ignore-daemonsets
        --delete-emptydir-data
        --grace-period=30
        --timeout=300s
      delegate_to: "{{ groups['control_plane'][0] }}"
      become_user: "{{ ansible_user }}"
      environment:
        KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
      when: k8s_conf.stat.exists
      register: drain_result
      failed_when: drain_result.rc != 0

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade System
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
        exclude: "{{ exclude_pkgs }}"
      register: apt_upgrade
      retries: 3
      delay: 5
      until: apt_upgrade is success

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot the node
      reboot:
        msg: "Rebooting for updates via Ansible"
        connect_timeout: 5
        reboot_timeout: 600
        post_reboot_delay: 30
      when: reboot_required.stat.exists

    - name: Wait for connection
      wait_for_connection:
        delay: 10
        timeout: 300
      when: reboot_required.stat.exists

    - name: Wait for kubelet to start
      service:
        name: kubelet
        state: started
      when: k8s_conf.stat.exists and reboot_required.stat.exists

    - name: Wait for K8s Node Ready status
      shell: >
        kubectl get node {{ k8s_node_name }} 
        -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      delegate_to: "{{ groups['control_plane'][0] }}"
      become_user: "{{ ansible_user }}"
      environment:
        KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      when: k8s_conf.stat.exists

    - name: Uncordon node
      command: kubectl uncordon {{ k8s_node_name }}
      delegate_to: "{{ groups['control_plane'][0] }}"
      become_user: "{{ ansible_user }}"
      environment:
        KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
      when: k8s_conf.stat.exists

    - name: Brief Pause for Stability
      pause:
        seconds: 15
      when: k8s_conf.stat.exists

- name: Post-update validation
  hosts: all
  become: true
  tasks:
    - name: Verify all nodes are accessible
      ping:

    - name: Check system uptime
      command: uptime
      register: system_uptime
      changed_when: false

    - name: Display uptime
      debug:
        msg: "{{ inventory_hostname }}: {{ system_uptime.stdout }}"

- name: Verify cluster health
  hosts: control_plane
  tasks:
    - name: Check all nodes status
      shell: kubectl get nodes -o wide
      become_user: "{{ ansible_user }}"
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      register: final_cluster_status
      run_once: true
      changed_when: false

    - name: Display final cluster status
      debug:
        var: final_cluster_status.stdout_lines
      run_once: true
      when: final_cluster_status.rc == 0

    - name: Check pod status
      shell: kubectl get pods --all-namespaces | grep -v "Running\|Completed" || echo "All pods running"
      become_user: "{{ ansible_user }}"
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      register: pod_status
      run_once: true
      changed_when: false

    - name: Display pod status
      debug:
        msg: "{{ pod_status.stdout_lines }}"
      run_once: true
      when: pod_status.rc == 0
